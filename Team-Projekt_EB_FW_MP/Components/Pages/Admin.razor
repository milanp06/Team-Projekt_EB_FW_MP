@page "/admin"
@using System.Net.NetworkInformation
@using System.Net.Sockets;
@rendermode InteractiveServer
@inject IJSRuntime JsRuntime
@inject VotingService votingService
@implements IDisposable


<div class="admin-container">

    <div class="header">
        <div class="header-content">
            <div class="icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                </svg>
            </div>
            <h1>QR-Code Generator</h1>
        </div>
        <p class="subtitle">Erstellen Sie sichere QR-Codes für die Authentifizierung</p>
    </div>

    <div class="content">
        <div class="action-card">
            <button class="btn-primary @(votingActive ? "" : "disabled")" disabled=@(!votingActive) @onclick="GenerateQr">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Neuen QR-Code erstellen
            </button>
        </div>

        @if (!string.IsNullOrEmpty(QrCodeBase64))
        {
            <div class="qr-display">
                <div class="qr-card">
                    <div class="qr-header">
                        <h3>Generierter QR-Code</h3>
                        <span class="badge">Aktiv</span>
                    </div>
                    <div class="qr-image-wrapper">
                        <img src="@QrCodeBase64" alt="QR Code" class="qr-image" />
                    </div>
                    <p class="qr-info">Scannen Sie diesen Code mit der mobilen App</p>
                </div>
            </div>
        }
    </div>

    <div class="admin-toggle" @onclick="@(() => { adminLogin = !adminLogin; })">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
        </svg>
    </div>

    <div class="admin-panel @(adminLogin ? "active" : "")">
        <div class="panel-content">
            <div class="panel-header">
                <h2>Admin Panel</h2>
                <button class="close-btn" @onclick="@(() => { adminLogin = false; })">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>

            <div class="admin-controls visible">
                <div class="control-grid">
                    <button @onclick="StartVoting" class="control-btn success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        Abstimmung starten
                    </button>
                    <button @onclick="StopVoting" class="control-btn dangerbtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="4" width="4" height="16" />
                            <rect x="14" y="4" width="4" height="16" />
                        </svg>
                        Abstimmung stoppen
                    </button>
                    <button @onclick="ResetVotes" class="control-btn warning">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="1 4 1 10 7 10" />
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                        </svg>
                        Alle Bewertungen löschen
                    </button>
                    <button @onclick="ClearLocalVote" class="control-btn info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
                        </svg>
                        Neue Abstimmung erlauben
                    </button>
                    <button @onclick="ChangePassword" class="control-btn secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                        Passwort ändern
                    </button>
                    <button @onclick="ExportExcel" class="control-btn primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Excel exportieren
                    </button>
                    <button @onclick="OpenImportPopup" class="control-btn import">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 10 12 5 7 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Excel importieren
                    </button>
                    <button @onclick="ChangeVotingType" class="control-btn voting">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="1 4 1 10 7 10" />
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                        </svg>
                        Votingtyp wechseln
                    </button>
                    <button disabled class="control-btn currvoting">
                        Typ: @votingService.VotingType
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(adminMsg))
                {
                    <div class="status-msg">@adminMsg</div>
                }

                <div class="summary-section">
                    <h3>Zusammenfassung</h3>
                    <div class="table-wrapper">
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Arbeit</th>
                                    <th>Punkte</th>
                                </tr>
                            </thead>

                            <tbody>
                                @if (collection.Count == 0)
                                {
                                    <tr>
                                        <td colspan="2" class="empty">
                                            Keine Ergebnisse vorhanden
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var result in SortedResults)
                                    {
                                        <tr>
                                            <td>@result.Arbeit</td>
                                            <td>@GetPoints(result)</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (showImportPopup)
{
    <div class="modal-backdrop" @onclick="CloseImportPopup">
        <div class="modal" @onclick:stopPropagation>
            <h3>Excel importieren</h3>

            <label class="dropzone" id="dropzone-area" for="fileInput">
                <InputFile @ref="inputFileRef" id="fileInput" OnChange="HandleExcelUpload" accept=".xlsx,.xls" class="file-input" />
                <div class="dropzone-content">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="upload-icon">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <p class="dropzone-text">Excel-Datei hier ablegen oder klicken</p>
                    <p class="dropzone-hint">XLSX oder XLS Dateien (max. 10 MB)</p>
                </div>
            </label>

            @if (!string.IsNullOrEmpty(importFileName))
            {
                <div class="file-info">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    <span>@importFileName</span>
                </div>
            }

            <div class="modal-actions">
                <button class="control-btn danger" @onclick="CloseImportPopup">Abbrechen</button>
            </div>
        </div>
    </div>
}



@code {
    private System.Threading.Timer? _refreshTimer;
    private InputFile? inputFileRef;
    private string QrCodeBase64 = "";

    private void GenerateQr()
    {
        var token = Guid.NewGuid().ToString();

        Console.WriteLine(token);

        // Token in DB speichern
        var qrToken = new QrToken(token, false);

        DatenbankLib.QrToken.AddQrToken(qrToken);

        //Server-IP
        string serverIp = NetworkInterface.GetAllNetworkInterfaces()
            .Where(n =>
                n.OperationalStatus == OperationalStatus.Up &&
                n.NetworkInterfaceType != NetworkInterfaceType.Loopback)
            .SelectMany(n => n.GetIPProperties().UnicastAddresses)
            .First(a => a.Address.AddressFamily == AddressFamily.InterNetwork)
            .Address
            .ToString();

        // QR-Code-Text = URL mit Token
        var qrUrl = $"http://{serverIp}:5432/login/{token}";

        // QR generieren
        using var qrGenerator = new QRCoder.QRCodeGenerator();
        var qrData = qrGenerator.CreateQrCode(qrUrl, QRCoder.QRCodeGenerator.ECCLevel.Q);
        using var qrCode = new QRCoder.QRCode(qrData);
        using var bitmap = qrCode.GetGraphic(20);

        using var ms = new MemoryStream();
        bitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
        QrCodeBase64 = $"data:image/png;base64,{Convert.ToBase64String(ms.ToArray())}";
    }

    private bool adminLogin = false;
    private bool isAdmin = true;
    private string loginMsg = "";
    private string adminMsg = "";

    private bool votingActive = false;
    private bool submitBtn = false;
    private bool hasVoted = false;

    public string votingType = "Schulvoting";
    private List<Results> collection = new();

    private bool showImportPopup = false;
    private string? importFileName;


    protected override void OnInitialized()
    {
        collection = DatenbankLib.Results.GetResults();


        _refreshTimer = new System.Threading.Timer(
            async _ => await RefreshResults(),
            null,
            TimeSpan.FromSeconds(15), // first run
            TimeSpan.FromSeconds(15)  // repeat
        );
    }

    private void ChangeVotingType()
    {
        if (votingService.VotingType == "Schulvoting") votingService.VotingType = "Publikumsvoting";
        else if (votingService.VotingType == "Publikumsvoting") votingService.VotingType = "Juryvoting";
        else votingService.VotingType = "Schulvoting";
    }

    private void StartVoting()
    {
        votingActive = true;
        adminMsg = "Abstimmung wurde gestartet.";
    }

    private void StopVoting()
    {
        votingActive = false;
        adminMsg = "Abstimmung wurde gestoppt.";
    }

    private void ClearLocalVote()
    {
        hasVoted = false;
        adminMsg = "Dieses Gerät darf erneut abstimmen.";

    }

    private async Task ResetVotes()
    {
        // bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Alle Bewertungen löschen?");
        // if (confirmed)
        // {
        //     resultEntry = new();
        //     RenderSummary(resultEntry);
        //     adminMsg = "Alle Bewertungen wurden gelöscht.";
        // }
    }

    private async Task ChangePassword()
    {
        string? input = await JsRuntime.InvokeAsync<string>(
            "showPrompt",
            "Bitte gib einen Text ein:",
            ""
        );

        if (input != null)
        {
            adminMsg = "Passwort wurde geändert.";
        }
        else
        {
            adminMsg = "Passwortänderung abgebrochen.";
        }
    }

    private void ExportExcel()
    {
        DatenbankLib.Project.CalculatePublikumsvoting();
    }

    private void OpenImportPopup()
    {
        showImportPopup = true;
        StateHasChanged();
        _ = InitializeDragDrop();
    }

    private async Task InitializeDragDrop()
    {
        await Task.Delay(100); // Wait for modal to render

        if (inputFileRef?.Element != null)
        {
            await JsRuntime.InvokeVoidAsync("setupDragDrop", "dropzone-area", inputFileRef.Element.Value);
        }
    }

    private async void CloseImportPopup()
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("removeDragDrop", "dropzone-area");
        }
        catch { }

        showImportPopup = false;
        importFileName = null;
        StateHasChanged();
    }

    private async Task HandleExcelUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        importFileName = file.Name;

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            byte[] fileBytes = ms.ToArray();

            // Process your Excel file here with fileBytes
            adminMsg = $"Excel '{file.Name}' wurde erfolgreich importiert.";

            await Task.Delay(1500);
            CloseImportPopup();
        }
        catch (Exception ex)
        {
            adminMsg = $"Fehler beim Importieren: {ex.Message}";
        }

        StateHasChanged();
    }

    private async Task RefreshResults()
    {
        collection = DatenbankLib.Results.GetResults();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private double GetPoints(Results result)
    {
        return votingService.VotingType switch
        {
            "Schulvoting" => result.Schulvoting,
            "Publikumsvoting" => result.Publikumsvoting,
            "Juryvoting" => result.Juryvoting,
            _ => 0
        };
    }

    private IEnumerable<Results> SortedResults => collection.OrderByDescending(r => GetPoints(r));
}