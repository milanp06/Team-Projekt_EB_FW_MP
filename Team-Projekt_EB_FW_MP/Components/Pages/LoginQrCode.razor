@page "/login/{Token}"
@rendermode InteractiveServer
@inject NavigationManager MyNavMgr
@inject MyCustomAuthStateProvider MyAuthProvider

<div class="login-container">
    <div class="login-card">
        <div class="logo-section">
            <img src="images/logo.png" alt="Logo" class="login-logo" />
        </div>

        <h1 class="login-title">FriendsOfAward</h1>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="message-box @(message.Contains("nicht") || message.Contains("verwendet") ? "error" : "success")">
                <svg class="message-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    @if (message.Contains("nicht") || message.Contains("verwendet"))
                    {
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    }
                    else
                    {
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    }
                </svg>
                <span>@message</span>
            </div>
        }
        else
        {
            <div class="loading-section">
                <div class="spinner"></div>
                <p class="loading-text">Authentifizierung läuft...</p>
            </div>
        }
    </div>

    <div class="background-decoration">
        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
        <div class="circle circle-3"></div>
    </div>
</div>

@code {
    [Parameter]
    public string Token { get; set; } = "";

    string message = "";

    protected override async Task OnInitializedAsync()
    {
        if (QrToken.CheckTokenExits(Token) == false)
        {
            message = "Token existiert nicht";
        }
        else if (QrToken.CheckTokenUsed(Token) == true)
        {
            message = "Token schon verwendet";
        }
        else
        {
            MyAuthProvider.Login(Token);
            MyNavMgr.NavigateTo($"/Home/{Token}");
        }
    }
}