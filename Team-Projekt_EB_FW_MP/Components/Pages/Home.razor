@page "/Home"
@rendermode InteractiveServer

<h1>Friends Of Award</h1>

<div class="legend-box">
	<p>Geben Sie uns Ihre persönlichen countFavoritenn bekannt!</p>
	<p>
		Einfacher Klick = Favorit (max. 5)<br />
		Doppelklick = Topfavorit (max. 1)
	</p>
	<p class="small-note">Diese Abstimmung ist anonym und auf ein Gerät beschränkt.</p>
</div>

<div class="buttonGrid">
	@foreach(int index in Enumerable.Range(0, selectableButtons.Count))
	{
		var selectableButton = selectableButtons[index];
		<button disabled="@(enableVoting ? false : true)" @ondblclick="() => HandleDblClick(index)" @onclick="() => HandleClick(index)" 
		class="@(selectableButton.Item2 == 1 ? "favorit" : selectableButton.Item2 == 2 ? "topfavorit" : "")">
		@(index+1)</button>
	}
</div>
<div class="message">@info</div>
<div class="message" style="color: @(hasVoted ? "green" : "red")">@fehlerMeldung</div>
<p><button class="submitBtn" disabled="@(submitBtn == false ? true : false)" @onclick="SubmitVote">Bewertung absenden</button></p>

<div class="adminToggle" @onclick="@(() => { adminLogin = !adminLogin; })">🏠</div>
<div class="adminPanel" style="display: @(adminLogin ? "block" : "none");">
	<h2>Admin Panel</h2>
	<div>
		<input type="password" @bind="adminPassword" />
        <button @onclick="CheckAdmin">Login</button>
        <button @onclick="LogoutAdmin">Logout</button>
	</div>
	<div id="adminControls" style="display: @(isAdmin ? "block" : "none");">
		<button @onclick="StartVoting">Abstimmung starten</button>
		<button @onclick="StopVoting">Abstimmung stoppen</button>
		<button @onclick="ResetVotes">Alle Bewertungen löschen</button>
		<button @onclick="ClearLocalVote">Neue Abstimmung auf diesem Gerät erlauben</button>
		<button @onclick="ChangePassword">Passwort ändern</button>
		<button @onclick="ExportExcel">Excel exportieren</button>
		<div id="adminStatus" style="margin-top:10px; color:blue;">@adminMsg</div>
		<table id="summaryTable">
			<thead>
				<tr>
					<th>Arbeit</th>
					<th>Anzahl Nennung Favorit</th>
					<th>Anzahl Nennung Topfavorit</th>
					<th>Punkte</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
</div>


@code {
	List<(string, int)> selectableButtons = new();

	private int countFavoriten = new();
	private List<int> favoritenList = new();
	private int countTopFavorit = 0;
	private int topFavorit = -1;

	private string info = "Offen 5 Favoriten, 1 Topfavorit";
	private string fehlerMeldung = "";

	private string adminPassword = "";
	private bool adminLogin = false;
	private bool isAdmin = false;
	private string adminMsg = "";

	private bool enableVoting = false;
	private bool votingActive = false;
	private bool submitBtn = false;

	private bool hasVoted = false;

	Results results;

	public class Results
	{

		List<int> Favoriten { get; set; } = new();
		int TopFavorit { get; set; } = -1;
		TimeOnly Time { get; set; }

		public Results(List<int> favoriten, int topFavorit, TimeOnly time)
		{
			Favoriten = favoriten;
			TopFavorit = topFavorit;
			Time = time;
		}
	}

	protected override Task OnInitializedAsync()
	{
		for (int i = 0; i < 20; i++)
		{
			selectableButtons.Add(($"selectedButton{i + 1}", 0));
		}

		EnableVoting();

		return base.OnInitializedAsync();
	}


	private void EnableVoting()
	{
		enableVoting = true;
		submitBtn = false;
	}

	private void DisableVoting()
	{
		enableVoting = false;
		submitBtn = false;
	}

	private void HandleClick(int btnIndex)
	{
		var button = selectableButtons[btnIndex];
		int newValue = 0;
		if (countFavoriten <= 4)
		{
			if (button.Item2 == 0)
			{
				newValue++;
				countFavoriten++;
				favoritenList.Add(btnIndex+1);
			}
		}

		if (button.Item2 == 1)
		{
			newValue = 0;
			countFavoriten--;
			favoritenList.Remove(btnIndex + 1);
		}
		if (button.Item2 == 2)
		{
			newValue = 0;
			countTopFavorit--;
			topFavorit = -1;
		}

		info = UpdateInfo();

		selectableButtons[btnIndex] = (button.Item1, newValue);
	}

	private void HandleDblClick(int btnIndex)
	{
		var button = selectableButtons[btnIndex];
		int newValue = 0;
		if (countTopFavorit == 0)
		{
			if (button.Item2 == 0)
			{
				newValue = 2;
				countTopFavorit++;
				topFavorit = btnIndex + 1;
			}
			else if (button.Item2 == 1)
			{
				newValue = 2;
				countFavoriten--;
				favoritenList.Remove(btnIndex + 1);
				countTopFavorit++;
				topFavorit = btnIndex+1;
			}
		}
		if (button.Item2 == 2)
		{
			newValue = 0;
			countTopFavorit--;
			topFavorit = -1;
		}

		info = UpdateInfo();


		selectableButtons[btnIndex] = (button.Item1, newValue);
	}

	private string UpdateInfo()
	{
		int maxFavs = 5;
		int remainingFavs = maxFavs - countFavoriten;
		int remainingTop = 1 - countTopFavorit;

		string infoText = $"Offen: {remainingFavs} Favoriten, {remainingTop} Topfavorit";

		if (remainingFavs == 0 && remainingTop == 0) submitBtn = true;
		else submitBtn = false;
		fehlerMeldung = remainingFavs == 0 ? "Maximal 5 Favoriten sind erlaubt." : "";

		return infoText;
	}

	private void SubmitVote()
	{
		if (submitBtn == false) return;
		results = new(
			favoritenList,
			topFavorit,
			TimeOnly.FromDateTime(DateTime.Now)
		);
		hasVoted = true;
		DisableVoting();
		info = "";
		fehlerMeldung = "Danke für Ihre Bewertung!";
		RenderSummary();
	}

	private void CheckAdmin()
	{
		if (adminPassword == "ayri") isAdmin = true;
		else isAdmin = false;
	}
	private void LogoutAdmin()
	{
		isAdmin = false;
	}
	private void StartVoting()
	{
		votingActive = true;
		adminMsg = "Abstimmung wurde gestartet.";
	}
	private void StopVoting()
	{
		votingActive = false;
		adminMsg = "Abstimmung wurde gestoppt.";
	}

	private void ClearLocalVote() { }
	private void ResetVotes() { }
	private void ChangePassword()
	{
		Console.Write("Neues Admin-Passwort eingeben:");
		string input = Console.ReadLine();
		adminPassword = input;
		adminMsg = "Passwort wurde geändert.";
	}
	private void ExportExcel() { }
	private void RenderSummary() { }
}